<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>George V. Reilly</title>
  <link media="all" href="/style.css" rel="stylesheet" />
  <link media="all" href="/pygments.css" rel="stylesheet" />
  <link href="/favicon.ico" rel="shortcut icon" />
    <link href="/sitemap.xml" type="application/xml" rel="sitemap" title="Sitemap">
  <link href="/" rel="home start" />
  <link href="/atom/" type="application/atom+xml" rel="alternate" title="Atom Feed" />
  <link href="/rss/" type="application/rss+xml" rel="alternate" title="RSS Feed" />
</head>
<body>
  <header>
    <h1><a href="/" rel="home start" class="blogtitle">George V. Reilly</a></h1>
    <nav>
      <ul>
        <li><a href="/blog/" rel="home start" title="George's full blog">blog</a></li>
        <li><a href="/til/" rel="home start" title="Today George Learned">TIL</a></li>
        <li><a href="/about/" rel="home start" title="About George">about</a></li>
        <li><a href="/atom/" rel="alternate" title="Atom Feed">atom</a></li>
        <li><a href="/rss/" rel="alternate" title="RSS Feed">rss</a></li>
        <li><a href="/articles/" rel="contents">articles</a></li>
        <li><a href="/tags/" rel="contents">tags</a></li>
      </ul>
    </nav>
  </header>
    
        <article>
    <header>
        <time datetime="2024-12-20">2024-12-20</time>
        <h1>
            <a href="/blog/2024/12/20/PatchingAirflowWheels.html" rel="bookmark canonical">Patching Airflow Wheels</a>
        </h1>
    </header>
    <p>In <a class="reference external" href="/blog/2024/12/16/PatchingAndSplittingPythonWheels.html">Patching and Splitting Python Wheels</a>,
I wrote about some occasions when I had to take a <a class="reference external" href="https://realpython.com/python-wheels/">Python wheel</a>
and patch it.
Now I want to tell you about a very different approach
that I used recently to patch Airflow wheels.</p>
<p>With the other wheels, we just needed to apply some tactical patches.
With Airflow, we are making sub&shy;stan&shy;tive changes.</p>
<a class="reference external image-reference" href="https://airflow.apache.org/"></a>
<p>We've been using <a class="reference external" href="https://airflow.apache.org/">Airflow</a> for years at work.
We built up a lot of in&shy;fra&shy;struc&shy;ture around Airflow 1
and we are gradually migrating to <a class="reference external" href="https://www.astronomer.io/blog/introducing-airflow-2-0/">Airflow 2</a>.</p>
<p>Several years ago, we forked the <a class="reference external" href="https://pypi.org/project/apache-airflow/">airflow package</a>
and made a large number of changes to it for internal con&shy;sump&shy;tion.
Un&shy;for&shy;tu&shy;nate&shy;ly, this made it in&shy;creas&shy;ing&shy;ly hard <span>&#8230;<a href="/blog/2024/12/20/PatchingAirflowWheels.html" class="continue">continue</a>.</span></p>
    <footer>
        
        
            <p>tagged as
                <a href="/tag/python/" rel="tag">python</a>
                
            </p>
        
    </footer>
    <div class="comments"></div>
</article>


    
        <article>
    <header>
        <time datetime="2024-12-16">2024-12-16</time>
        <h1>
            <a href="/blog/2024/12/16/PatchingAndSplittingPythonWheels.html" rel="bookmark canonical">Patching and Splitting Python Wheels</a>
        </h1>
    </header>
    
<p>I gave lightning talks at <a class="reference external" href="https://www.meetup.com/pythonireland/events/300802991/">Python Ireland</a> in May 2024 and
<a class="reference external" href="https://www.meetup.com/psppython/events/302211630/">Puget Sound Pro&shy;gram&shy;ming Python (PuPPy)</a> in August 2024
about patching and splitting wheels: <a class="reference external" href="https://docs.google.com/presentation/d/1YXfI7U1oVgHLSgX8uYieIGdooQK-jTqXWMhpkUrAo4U/edit?usp=sharing">slides</a>.</p>
<div class="section" id="patching-wheels">
<h2>Patching Wheels</h2>
<p>Last year, I wrote about manually <a class="reference external" href="/blog/2023/08/10/PatchingAPythonWheel.html">Patching a Python Wheel</a>.
There was a cyclic dependency
between the Torch 2.0.1 wheel and the Triton 2.0.0 wheel.
While <tt class="docutils literal">pip</tt> had no problem with this,
<a class="reference external" href="https://bazel.build/">Bazel</a> certainly did.
My <a class="reference external" href="/blog/2023/08/10/PatchingAPythonWheel.html">workaround</a> was to unzip the Torch wheel,
edit the metadata to remove the dependency on Triton,
and zip the wheel up again with a modified name.</p>
<p>At the beginning of this year,
I had to patch Torch 2.1 for <a class="reference external" href="https://github.com/georgevreilly/torch21">different reasons</a>.
Again, I needed to patch the Torch wheel because of <span>&#8230;<a href="/blog/2024/12/16/PatchingAndSplittingPythonWheels.html" class="continue">continue</a>.</span></p></div>
    <footer>
        
        
            <p>tagged as
                <a href="/tag/python/" rel="tag">python</a>
                
            </p>
        
    </footer>
    <div class="comments"></div>
</article>


    
        <article>
    <header>
        <time datetime="2023-09-26">2023-09-26</time>
        <h1>
            <a href="/blog/2023/09/26/ExploringWordle.html" rel="bookmark canonical">Exploring Wordle</a>
        </h1>
    </header>
    <p>Unless YOUVE LIVED UNDER ROCKS, you've heard of <a class="reference external" href="https://en.wikipedia.org/wiki/Wordle">Wordle</a>,
the online word game that has become wildly popular since late 2021.
You've probably seen people posting their Wordle games
as grids of little green, yellow, and black (or white) emojis on social media.</p>
<div class="line-block">
<div class="line">Wordle 797 4/6</div>
<div class="line"><br /></div>
<div class="line">⬛ ⬛ ⬛ ⬛ 🟨</div>
<div class="line">🟨 ⬛ 🟩 ⬛ ⬛</div>
<div class="line">⬛ ⬛ 🟩 🟨 ⬛</div>
<div class="line">🟩 🟩 🟩 🟩 🟩</div>
</div>
<p>The problem that I want to address in this post is:</p>
<blockquote>
Given some <tt class="docutils literal">GUESS=SCORE</tt> pairs for Wordle and a word list,
pro&shy;gram&shy;mat&shy;i&shy;cal&shy;ly find all the words from the list
that are eligible as answers.</blockquote>
<p>Let's look at this four-round game for Wordle 797:</p>
<table class="wordle">
  <tr><td class="absent">J</td> <td class="absent">U</td> <td class="absent">D</td> <span>&#8230;<a href="/blog/2023/09/26/ExploringWordle.html" class="continue">continue</a>.</span></tr></table>
    <footer>
        
        
            <p>tagged as
                <a href="/tag/python/" rel="tag">python</a>
                    and
                    
                <a href="/tag/wordle/" rel="tag">wordle</a>
                
            </p>
        
    </footer>
    <div class="comments"></div>
</article>


    
        <article>
    <header>
        <time datetime="2023-09-02">2023-09-02</time>
        <h1>
            <a href="/blog/2023/09/02/PythonEnumsWithAttributes.html" rel="bookmark canonical">Python Enums with Attributes</a>
        </h1>
    </header>
    <p>Python <a class="reference external" href="https://realpython.com/python-enum/">enu&shy;mer&shy;a&shy;tions</a> are useful for grouping related constants in a namespace.
You can add additional behaviors to an enum class,
but there isn't an easy and obvious way
to add attributes to enum members.</p>
<pre class="code python literal-block">
<span class="k">class</span> <span class="nc">TileState</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">CORRECT</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">PRESENT</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">ABSENT</span>  <span class="o">=</span> <span class="mi">3</span>

    <span class="k">def</span> <span class="nf">color</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">CORRECT</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Green&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">PRESENT</span><span class="p">:</span>
          </pre><span>&#8230;<a href="/blog/2023/09/02/PythonEnumsWithAttributes.html" class="continue">continue</a>.</span>
    <footer>
        
        
            <p>tagged as
                <a href="/tag/python/" rel="tag">python</a>
                    and
                    
                <a href="/tag/til/" rel="tag">til</a>
                
            </p>
        
    </footer>
    <div class="comments"></div>
</article>


    
        <article>
    <header>
        <time datetime="2023-08-10">2023-08-10</time>
        <h1>
            <a href="/blog/2023/08/10/PatchingAPythonWheel.html" rel="bookmark canonical">Patching a Python Wheel</a>
        </h1>
    </header>
    <p>Recently, I had to create a new <a class="reference external" href="https://realpython.com/python-wheels/">Python wheel</a> for <a class="reference external" href="https://pytorch.org/">PyTorch</a>.
There is a <a class="reference external" href="https://github.com/pytorch/pytorch/issues/99622">cyclic dependency</a> between PyTorch 2.0.1 and Triton 2.0.0:
Torch depends upon Triton, but Triton also depends on Torch.
<a class="reference external" href="https://pip.pypa.io/en/latest/">Pip</a> is okay with installing packages where there's a cyclic dependency.
<a class="reference external" href="https://bazel.build/">Bazel</a>, however, <a class="reference external" href="https://github.com/bazelbuild/rules_python/issues/1076">does not handle</a> cyclic de&shy;pen&shy;den&shy;cies between packages.
We use Bazel ex&shy;ten&shy;sive&shy;ly at Stripe
and this cyclic dependency prevented us from using the latest version of Torch.</p>
<p>I spent a few days trying to build the PyTorch wheel from source.
It was a <em>nightmare!</em>
I ran out of disk space on the root partition on my EC2 devbox
trying to install system packages,
so I had to <span>&#8230;<a href="/blog/2023/08/10/PatchingAPythonWheel.html" class="continue">continue</a>.</span></p>
    <footer>
        
        
            <p>tagged as
                <a href="/tag/python/" rel="tag">python</a>
                
            </p>
        
    </footer>
    <div class="comments"></div>
</article>


    
        <article>
    <header>
        <time datetime="2022-12-19">2022-12-19</time>
        <h1>
            <a href="/blog/2022/12/19/BackwardsRangesInPython.html" rel="bookmark canonical">Backwards Ranges in Python</a>
        </h1>
    </header>
    <p>In Python, if you want to specify a sequence of numbers
from <code>a</code> up to (but excluding) <code>b</code>,
you can write <code>range(a, b)</code>.
This generates the sequence <code>a, a+1, a+2, ..., b-1</code>.
You start at <code>a</code> and keep going until the next number would be <code>b</code>.</p>
<p>In Python 3, <code>range</code> is <em>lazy</em>
and the values in the sequence do not ma&shy;te&shy;ri&shy;al&shy;ize
until you consume the range.</p>
<div class="codehilite"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">12</span><span class="p">)</span>
<span class="go">range(3, 12)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">12</span><span class="p">))</span>
<span class="go">[3, 4, 5, 6, 7, 8, 9, 10, 11]</span>
</pre></div>


<p>Trey Hunner makes the point that
<a href="https://treyhunner.com/2018/02/python-range-is-not-an-iterator/">range is a lazy iterable</a>
rather than an iterator.</p>
<p>You can also <em>step</em> by an increment other than one:
<code>range(a, b, s)</code>.
This generates <code>a, a+s, a+2*s, ..., b-s</code>
(assuming that <span>&#8230;<a href="/blog/2022/12/19/BackwardsRangesInPython.html" class="continue">continue</a>.</span></p>
    <footer>
        
        
            <p>tagged as
                <a href="/tag/python/" rel="tag">python</a>
                    and
                    
                <a href="/tag/til/" rel="tag">til</a>
                
            </p>
        
    </footer>
    <div class="comments"></div>
</article>


    
        <article>
    <header>
        <time datetime="2021-10-04">2021-10-04</time>
        <h1>
            <a href="/blog/2021/10/04/AccidentallyQuadraticPythonListMembership.html" rel="bookmark canonical">Accidentally Quadratic: Python List Membership</a>
        </h1>
    </header>
    <p>We had a per&shy;for&shy;mance regression in a test suite recently
when the median test time jumped by two minutes.</p>
<a class="reference external image-reference" href="https://www.bigocheatsheet.com/"></a>
<p>We tracked it down to this (simplified) code fragment:</p>
<pre class="code python literal-block">
<span class="n">task_inclusions</span> <span class="o">=</span> <span class="p">[</span> <span class="n">some_collection_of_tasks</span><span class="p">()</span> <span class="p">]</span>
<span class="n">invalid_tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">task_id</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">airflow_tasks</span>
                 <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">task_id</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">task_inclusions</span><span class="p">]</span>
</pre>
<p>This looks fairly in&shy;nocu&shy;ous—and it was—until the size of the result returned from <tt class="docutils literal">some_&shy;col&shy;lec&shy;tion_of_&shy;tasks()</tt>
jumped from a few hundred to a few thousand.</p>
<p>The <a class="reference external" href="https://docs.python.org/3/reference/expressions.html#membership-test-operations">in comparison operator</a> con&shy;ve&shy;nient&shy;ly works
with all of Python's standard sequences and col&shy;lec&shy;tions,
but its efficiency varies.
For a <tt class="docutils literal">list</tt> and other sequences,
<tt class="docutils literal">in</tt> must search <span>&#8230;<a href="/blog/2021/10/04/AccidentallyQuadraticPythonListMembership.html" class="continue">continue</a>.</span></p>
    <footer>
        
        
            <p>tagged as
                <a href="/tag/python/" rel="tag">python</a>,
                <a href="/tag/performance/" rel="tag">performance</a>
                    and
                    
                <a href="/tag/til/" rel="tag">til</a>
                
            </p>
        
    </footer>
    <div class="comments"></div>
</article>


    
        <article>
    <header>
        <time datetime="2017-02-21">2017-02-21</time>
        <h1>
            <a href="/blog/2017/02/21/OrderedDictInitialization.html" rel="bookmark canonical">OrderedDict Initialization</a>
        </h1>
    </header>
    <p>An <a class="reference external" href="https://docs.python.org/2/library/collections.html#collections.OrderedDict">Or&shy;dered&shy;Dict</a> is a Python <tt class="docutils literal">dict</tt> which remembers insertion order.
When iterating over an <tt class="docutils literal">Or&shy;dered&shy;Dict</tt>, items are returned in that order.
Ordinary <tt class="docutils literal">dicts</tt> return their items in an un&shy;spec&shy;i&shy;fied order.</p>
<p>Ironically, most of the ways of con&shy;struct&shy;ing an ini&shy;tial&shy;ized <tt class="docutils literal">Or&shy;dered&shy;Dict</tt>
end up breaking the ordering in Python 2.x and in Python 3.5 and below.
Specif&shy;i&shy;cal&shy;ly, using keyword arguments or passing a <tt class="docutils literal">dict</tt> (mapping)
will not retain the insertion order of the source code.</p>
<pre class="code pycon literal-block">
<span class="go">Python 2.7.13 (default, Dec 18 2016, 07:03:39)
</span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="go">
</span><span class="gp">&gt;&gt;&gt; </span><span class="n">odict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">odict</span><span class="p">[</span><span class="s1">'one'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">odict</span><span class="p">[</span><span class="s1">'two'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">odict</span><span class="p">[</span><span class="s1">'three'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">odict</span><span class="p">[</span><span class="s1">'four'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">odict</span><span class="p">[</span><span class="s1">'five'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">odict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="go">[('one', 1), ('two', 2), ('three', </span></pre><span>&#8230;<a href="/blog/2017/02/21/OrderedDictInitialization.html" class="continue">continue</a>.</span>
    <footer>
        
        
            <p>tagged as
                <a href="/tag/python/" rel="tag">python</a>,
                <a href="/tag/hashtables/" rel="tag">hashtables</a>
                    and
                    
                <a href="/tag/til/" rel="tag">til</a>
                
            </p>
        
    </footer>
    <div class="comments"></div>
</article>


    
        <article>
    <header>
        <time datetime="2016-09-06">2016-09-06</time>
        <h1>
            <a href="/blog/2016/09/06/AlembicDataMigrations.html" rel="bookmark canonical">Alembic: Data Migrations</a>
        </h1>
    </header>
    <p>We use <a class="reference external" href="http://alembic.zzzcomputing.com/en/latest/">Alembic</a> to perform schema migrations
whenever we add (or drop) tables or columns
from our databases.
It's less well known that Alembic can also perform data migrations,
updating existing data in tables.</p>
<p>Here's an example adapted from a migration I put together this afternoon.
I added a non-NULL Boolean <tt class="docutils literal">stooge</tt> column to the <tt class="docutils literal">old_timers</tt> table,
with a default value of <tt class="docutils literal">FALSE</tt>.
I wanted to update certain rows to have <tt class="docutils literal">stooge=TRUE</tt> as part of the migration.
The following works with PostgreSQL.</p>
<p>Note the <tt class="docutils literal">server_de&shy;fault=sa.false()</tt> in the de&shy;c&shy;la&shy;ra&shy;tion of the <tt class="docutils literal">stooge</tt> column,
which is needed to initially set all instances of <tt class="docutils literal">stooge=FALSE</tt>.
I then declare a <tt class="docutils literal">table</tt> which has only the two <span>&#8230;<a href="/blog/2016/09/06/AlembicDataMigrations.html" class="continue">continue</a>.</span></p>
    <footer>
        
        
            <p>tagged as
                <a href="/tag/python/" rel="tag">python</a>,
                <a href="/tag/sql/" rel="tag">sql</a>
                    and
                    
                <a href="/tag/til/" rel="tag">til</a>
                
            </p>
        
    </footer>
    <div class="comments"></div>
</article>


    
        <article>
    <header>
        <time datetime="2016-08-06">2016-08-06</time>
        <h1>
            <a href="/blog/2016/08/06/Rounding.html" rel="bookmark canonical">Rounding</a>
        </h1>
    </header>
    <p>I recently learned from a <a class="reference external" href="http://stackoverflow.com/questions/10825926/python-3-x-rounding-behavior">Stack&shy;Over&shy;flow question</a>
that the rounding behavior in Python 3.x is different from Python 2.x:</p>
<blockquote>
The round() function rounding strategy and return type have changed.
Exact halfway cases are now rounded to the nearest even result
instead of away from zero.
(For example, round(2.5) now returns 2 rather than 3.)</blockquote>
<p>The “away from zero” rounding strategy is the one that most of us learned at school.
The “nearest even” strategy is also known as “banker’s rounding”.</p>
<p>There are actually <a class="reference external" href="https://en.wikipedia.org/wiki/IEEE_floating_point#Rounding_rules">five rounding strategies defined in IEEE 754</a>:</p>
<table border="1" class="docutils">
<colgroup>
<col width="58%"/>
<col width="11%"/>
<col width="11%"/>
<col width="11%"/>
<col width="11%"/>
</colgroup>
<thead valign="bottom">
<tr><th class="head">Mode / Example Value</th>
<th class="head">+11.5</th>
<th class="head">+12.5</th>
<th class="head">−11.5</th>
<th class="head">−12.5</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>to nearest, ties to even</td>
<td>+12.0</td>
<td>+12.0</td>
<td>−12.0</td>
<td>−12.0</td>
</tr>
<tr><td>to nearest, ties away from zero</td>
<td>+12.0</td>
<td>+13.0</td>
<td>−12.0</td>
<td>−13.0</td>
</tr>
<tr><td>toward 0 (truncation)</td>
<td>+11.0</td>
<td>+12.0</td>
<td>−11.0</td>
<td>−12.0</td>
</tr>
<tr><td>toward +∞ (ceiling)</td>
<td>+12.0</td>
<td>+13.0</td>
<td>−11.0</td>
<td>−12.0</td>
</tr>
<tr><td>toward −∞ (floor)</td>
<td>+11.0</td>
<td>+12.0</td>
<td>−12.0</td>
<td>−13.0</td>
</tr>
</tbody>
</table>
<p>Further <span>&#8230;<a href="/blog/2016/08/06/Rounding.html" class="continue">continue</a>.</span></p>
    <footer>
        
        
            <p>tagged as
                <a href="/tag/python/" rel="tag">python</a>,
                <a href="/tag/math/" rel="tag">math</a>
                    and
                    
                <a href="/tag/til/" rel="tag">til</a>
                
            </p>
        
    </footer>
    <div class="comments"></div>
</article>


    
    
        <a href="/tag/python/2/" class="page floatright">
        Previous &raquo;
        </a>
    
    
<footer>
    
    
    <p>written by <a href="mailto:george@reilly.org">George V. Reilly</a></p>
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="copyright license">
        <img src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" alt="by-nc-sa" />
    </a>
    <script data-goatcounter="https://georgevreilly.goatcounter.com/count"
            async src="//gc.zgo.at/count.js"></script>
    
    

  </footer>
</body>
</html>
