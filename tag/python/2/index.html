<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>George V. Reilly</title>
  <link media="all" href="/style.css" rel="stylesheet" />
  <link media="all" href="/pygments.css" rel="stylesheet" />
  <link href="/favicon.ico" rel="shortcut icon" />
    <link href="/sitemap.xml" type="application/xml" rel="sitemap" title="Sitemap">
  <link href="/" rel="home start" />
  <link href="/atom/" type="application/atom+xml" rel="alternate" title="Atom Feed" />
  <link href="/rss/" type="application/rss+xml" rel="alternate" title="RSS Feed" />
</head>
<body>
  <header>
    <h1><a href="/" rel="home start" class="blogtitle">George V. Reilly</a></h1>
    <nav>
      <ul>
        <li><a href="/blog/" rel="home start" title="George's full blog">blog</a></li>
        <li><a href="/til/" rel="home start" title="Today George Learned">TIL</a></li>
        <li><a href="/about/" rel="home start" title="About George">about</a></li>
        <li><a href="/atom/" rel="alternate" title="Atom Feed">atom</a></li>
        <li><a href="/rss/" rel="alternate" title="RSS Feed">rss</a></li>
        <li><a href="/articles/" rel="contents">articles</a></li>
        <li><a href="/tags/" rel="contents">tags</a></li>
      </ul>
    </nav>
  </header>
    
        <article>
    <header>
        <time datetime="2016-08-06">2016-08-06</time>
        <h1>
            <a href="/blog/2016/08/06/Rounding.html" rel="bookmark canonical">Rounding</a>
        </h1>
    </header>
    <p>I recently learned from a <a class="reference external" href="http://stackoverflow.com/questions/10825926/python-3-x-rounding-behavior">Stack&shy;Over&shy;flow question</a>
that the rounding behavior in Python 3.x is different from Python 2.x:</p>
<blockquote>
The round() function rounding strategy and return type have changed.
Exact halfway cases are now rounded to the nearest even result
instead of away from zero.
(For example, round(2.5) now returns 2 rather than 3.)</blockquote>
<p>The “away from zero” rounding strategy is the one that most of us learned at school.
The “nearest even” strategy is also known as “banker’s rounding”.</p>
<p>There are actually <a class="reference external" href="https://en.wikipedia.org/wiki/IEEE_floating_point#Rounding_rules">five rounding strategies defined in IEEE 754</a>:</p>
<table border="1" class="docutils">
<colgroup>
<col width="58%"/>
<col width="11%"/>
<col width="11%"/>
<col width="11%"/>
<col width="11%"/>
</colgroup>
<thead valign="bottom">
<tr><th class="head">Mode / Example Value</th>
<th class="head">+11.5</th>
<th class="head">+12.5</th>
<th class="head">−11.5</th>
<th class="head">−12.5</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>to nearest, ties to even</td>
<td>+12.0</td>
<td>+12.0</td>
<td>−12.0</td>
<td>−12.0</td>
</tr>
<tr><td>to nearest, ties away from zero</td>
<td>+12.0</td>
<td>+13.0</td>
<td>−12.0</td>
<td>−13.0</td>
</tr>
<tr><td>toward 0 (truncation)</td>
<td>+11.0</td>
<td>+12.0</td>
<td>−11.0</td>
<td>−12.0</td>
</tr>
<tr><td>toward +∞ (ceiling)</td>
<td>+12.0</td>
<td>+13.0</td>
<td>−11.0</td>
<td>−12.0</td>
</tr>
<tr><td>toward −∞ (floor)</td>
<td>+11.0</td>
<td>+12.0</td>
<td>−12.0</td>
<td>−13.0</td>
</tr>
</tbody>
</table>
<p>Further <span>&#8230;<a href="/blog/2016/08/06/Rounding.html" class="continue">continue</a>.</span></p>
    <footer>
        
        
            <p>tagged as
                <a href="/tag/python/" rel="tag">python</a>,
                <a href="/tag/math/" rel="tag">math</a>
                    and
                    
                <a href="/tag/til/" rel="tag">til</a>
                
            </p>
        
    </footer>
    <div class="comments"></div>
</article>


    
        <article>
    <header>
        <time datetime="2016-07-14">2016-07-14</time>
        <h1>
            <a href="/blog/2016/07/14/SQLAlchemyGotMeKilled.html" rel="bookmark canonical">SQLAlchemy got me Killed</a>
        </h1>
    </header>
    <p>I ran a script this afternoon that died mys&shy;te&shy;ri&shy;ous&shy;ly without any output.
It was using <a class="reference external" href="http://www.sqlalchemy.org/">SQLAlchemy</a> to query all the rows from a large table
so that they could be trans&shy;formed into <a class="reference external" href="http://jsonlines.org/">JSON Lines</a> to be loaded into Elas&shy;tic&shy;search.
When I reran my script,
I noticed this time that something had printed <tt class="docutils literal">Killed</tt> at the very end.</p>
<p>A little research convinced me that the <a class="reference external" href="http://stackoverflow.com/questions/726690/who-killed-my-process-and-why">OOM Killer</a> was the likely assassin.
I looked in <tt class="docutils literal">/var/log/kern.log</tt>
and I found that my process had used up almost all of the 8GB on this system
before being killed.</p>
<p>The query had to be the problem.
A little more research led me to augment my <span>&#8230;<a href="/blog/2016/07/14/SQLAlchemyGotMeKilled.html" class="continue">continue</a>.</span></p>
    <footer>
        
        
            <p>tagged as
                <a href="/tag/python/" rel="tag">python</a>
                    and
                    
                <a href="/tag/til/" rel="tag">til</a>
                
            </p>
        
    </footer>
    <div class="comments"></div>
</article>


    
        <article>
    <header>
        <time datetime="2016-07-12">2016-07-12</time>
        <h1>
            <a href="/blog/2016/07/12/PythonJoiningUrlsWithPosixpathJoin.html" rel="bookmark canonical">Python: Joining URLs with posixpath.join</a>
        </h1>
    </header>
    <p>On Mac/Linux, <a class="reference external" href="https://docs.python.org/2/library/os.path.html#os.path.join">os.path.join</a> is an alias for <tt class="docutils literal">posixpath.join</tt>,
which always joins path segments with <tt class="docutils literal">/</tt>.
On Windows, <tt class="docutils literal">os.path.join</tt> is an alias for <tt class="docutils literal">ntpath.join</tt>,
which always uses <tt class="docutils literal">\</tt>.
When dealing with URLs, we always want forward slashes,
regardless of platform, so <tt class="docutils literal">posixpath.join</tt> should be used to build URL paths.</p>
<p>Running:</p>
<pre class="code python literal-block">
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">from</span> <span class="nn">six.moves.urllib_parse</span> <span class="kn">import</span> <span class="n">urljoin</span> <span class="k">as</span> <span class="n">abs_urljoin</span>
<span class="kn">from</span> <span class="nn">posixpath</span> <span class="kn">import</span> <span class="n">join</span> <span class="k">as</span> <span class="n">path_urljoin</span>

<span class="k">def</span> <span class="nf">urljoin</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">abs_urljoin</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_join</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;'</span><span class="si">{0}</span><span class="s2">' + '</span><span class="si">{1}</span><span class="s2">'</span><span class="se">\n\t</span><span class="s2">-&gt; '</span><span class="si">{2}</span><span class="s2">'&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="n">local_path</span> <span class="o">=</span> <span class="n">path_urljoin</span><span class="p">(</span><span class="s1">'2016'</span><span class="p">,</span> <span class="s1">'07'</span><span class="p">,</span> <span class="s1">'12'</span><span class="p">,</span> <span class="s1">'release'</span><span class="p">,</span> <span class="s1">'index.html'</span><span class="p">)</span>

<span class="n">test_join</span><span class="p">(</span><span class="s1">'https://www.example.com'</span><span class="p">,</span> <span class="s1">'foo/bar/quux.js'</span><span class="p">)</span>
<span class="n">test_join</span><span class="p">(</span><span class="s1">'https://www.example.com'</span><span class="p">,</span> <span class="n">local_path</span><span class="p">)</span>
<span class="n">test_join</span><span class="p">(</span><span class="s1">'https://www.example.com/'</span><span class="p">,</span> <span class="n">local_path</span><span class="p">)</span>
<span class="n">test_join</span><span class="p">(</span><span class="s1">'https://www.example.com/prefix'</span><span class="p">,</span> <span class="n">local_path</span><span class="p">)</span>
</pre>
<p>Yields:</p>
<pre class="literal-block">
'https://www.example.com' + 'foo/bar/quux.js'
  </pre><span>&#8230;<a href="/blog/2016/07/12/PythonJoiningUrlsWithPosixpathJoin.html" class="continue">continue</a>.</span>
    <footer>
        
        
            <p>tagged as
                <a href="/tag/python/" rel="tag">python</a>
                    and
                    
                <a href="/tag/til/" rel="tag">til</a>
                
            </p>
        
    </footer>
    <div class="comments"></div>
</article>


    
        <article>
    <header>
        <time datetime="2016-07-11">2016-07-11</time>
        <h1>
            <a href="/blog/2016/07/11/LoggingInPythonDontUseNew-FangledFormat.html" rel="bookmark canonical">Logging in Python: Don't use new-fangled format</a>
        </h1>
    </header>
    <p>Python 2.6 introduced the <a class="reference external" href="https://pyformat.info/">format method</a> to strings.
In general, <tt class="docutils literal">format</tt> is now the preferred way to build strings
instead of the old <tt class="docutils literal">%</tt> formatting operator.</p>
<p>One exception is with the <tt class="docutils literal">logging</tt> module,
where the best practice is to use <tt class="docutils literal">%s</tt> and <tt class="docutils literal">%d</tt>.
Why?
First, <tt class="docutils literal">%s</tt> is the idiomatic way to use <tt class="docutils literal">logging</tt>,
which was built years before <tt class="docutils literal">format</tt> was introduced.
Second, if there's a literal <tt class="docutils literal">%</tt> in the in&shy;ter&shy;po&shy;lat&shy;ed values,
<tt class="docutils literal">logging</tt> will be unhappy,
since there won't be cor&shy;re&shy;spond&shy;ing arguments in the call.
It won't fall over, since
“The logging package is designed to swallow exceptions which occur while logging in production.
This is so that errors which occur while handling logging <span>&#8230;<a href="/blog/2016/07/11/LoggingInPythonDontUseNew-FangledFormat.html" class="continue">continue</a>.</span></p>
    <footer>
        
        
            <p>tagged as
                <a href="/tag/python/" rel="tag">python</a>
                    and
                    
                <a href="/tag/til/" rel="tag">til</a>
                
            </p>
        
    </footer>
    <div class="comments"></div>
</article>


    
        <article>
    <header>
        <time datetime="2016-06-01">2016-06-01</time>
        <h1>
            <a href="/blog/2016/06/01/HouseCanaryPyCon2016ProgammingChallenge.html" rel="bookmark canonical">HouseCanary PyCon2016 Progamming Challenge</a>
        </h1>
    </header>
    <p>Yesterday, while at PyCon,
I whipped up a quick, brute-force answer
to the <a class="reference external" href="https://github.com/housecanary/PyCon2016">House&shy;Ca&shy;nary PyCon2016 Progamming Challenge</a>
in a few minutes.
That was sufficient to pass the first two test cases
and win me a very pretty House&shy;Ca&shy;nary t-shirt.</p>
<p>The answer ran in <em>O(n⁴)</em> time, so it failed miserably on the larger problem sets
in the third and fourth cases.
I mulled it over and came up with an <em>O(n²)</em> solution that runs in reasonable time
on the larger problem sets.
On the second test case, <tt class="docutils literal">input1.txt</tt>, runtime drops from 5.2s to 0.2s.</p>
<p>I submitted my new answer.
I'll learn on Monday if I won the speed challenge.</p>

    <footer>
        
        
            <p>tagged as
                <a href="/tag/python/" rel="tag">python</a>
                
            </p>
        
    </footer>
    <div class="comments"></div>
</article>


    
        <article>
    <header>
        <time datetime="2016-05-29">2016-05-29</time>
        <h1>
            <a href="/blog/2016/05/29/FlyingCloudDocumentationUpdates.html" rel="bookmark canonical">FlyingCloud Documentation Updates</a>
        </h1>
    </header>
    <a class="reference external image-reference" href="http://flyingcloud.readthedocs.io/"></a>
<p>I made a number of updates to the <a class="reference external" href="http://flyingcloud.readthedocs.io/">Fly&shy;ing&shy;Cloud Doc&shy;u&shy;men&shy;ta&shy;tion</a> tonight.
I hope to give a lightning talk about Fly&shy;ing&shy;Cloud
at PyCon on Monday evening or Tuesday morning,
and I put together some slides for that too.</p>

    <footer>
        
        
            <p>tagged as
                <a href="/tag/docker/" rel="tag">docker</a>
                    and
                    
                <a href="/tag/python/" rel="tag">python</a>
                
            </p>
        
    </footer>
    <div class="comments"></div>
</article>


    
        <article>
    <header>
        <time datetime="2016-04-13">2016-04-13</time>
        <h1>
            <a href="/blog/2016/04/13/io.StringIOAndUnicodeCSV_DictWriter.html" rel="bookmark canonical">io.StringIO and UnicodeCSV DictWriter</a>
        </h1>
    </header>
    <p>I like to use <a class="reference external" href="https://docs.python.org/2/library/io.html#io.StringIO">io.StringIO</a> rather than the older <a class="reference external" href="https://docs.python.org/2/library/stringio.html#cStringIO.StringIO">cStringIO.StringIO</a>,
as it's Python 3–ready
<tt class="docutils literal">io.StringIO</tt> is also a <a class="reference external" href="https://docs.python.org/2/reference/datamodel.html#context-managers">context manager</a>:
if you use it in a <tt class="docutils literal">with</tt> statement,
the string buffer is au&shy;to&shy;mat&shy;i&shy;cal&shy;ly <tt class="docutils literal">close</tt>d as you go out of scope.</p>
<p>I tried using <tt class="docutils literal">io.StringIO</tt> with <a class="reference external" href="https://github.com/jdunck/python-unicodecsv">unicodecsv</a>,
as I wanted to capture the CSV output into a string buffer
for use with unit tests.
<tt class="docutils literal">unicodecsv</tt> is a drop-in re&shy;place&shy;ment for Python's built-in <tt class="docutils literal">csv</tt> module,
which supports Unicode strings.</p>
<pre class="code python literal-block">
<span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span> <span class="k">as</span> <span class="n">csv_file</span><span class="p">:</span>
    <span class="n">write_csv_rows</span><span class="p">(</span><span class="n">csv_file</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">csv_file</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'</span><span class="se">\r\n</span><span class="s1">'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lines</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># drop empty line after trailing \r\n</span>
</pre>
<p>It failed horribly with
<tt class="docutils literal">TypeError: unicode argument expected, <span>&#8230;<a href="/blog/2016/04/13/io.StringIOAndUnicodeCSV_DictWriter.html" class="continue">continue</a>.</span></tt></p>
    <footer>
        
        
            <p>tagged as
                <a href="/tag/python/" rel="tag">python</a>
                    and
                    
                <a href="/tag/til/" rel="tag">til</a>
                
            </p>
        
    </footer>
    <div class="comments"></div>
</article>


    
        <article>
    <header>
        <time datetime="2016-04-05">2016-04-05</time>
        <h1>
            <a href="/blog/2016/04/05/DoctestsUnicodeLiteralsPython2_3Compat.html" rel="bookmark canonical">Doctests, Unicode Literals, and Python 2/3 Compatibility</a>
        </h1>
    </header>
    <p>I rarely use <a class="reference external" href="https://pymotw.com/2/doctest/">doctests</a>, but I do have <a class="reference external" href="https://code.activestate.com/recipes/578031-sorting-a-dicts-items-and-keys/">some code</a> that uses them.</p>
<p>Although I still mostly write Python 2,
I usually import several features of Python 3:</p>
<pre class="code python literal-block">
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">absolute_import</span>
</pre>
<p>Un&shy;for&shy;tu&shy;nate&shy;ly <a class="reference external" href="http://python-future.org/unicode_literals.html">uni&shy;code_lit&shy;er&shy;als</a> doesn't play well with doctests.</p>
<p>The following code will pass with <tt class="docutils literal">python2 <span class="pre">-m</span> doctest demo.py</tt>,
but not with <tt class="docutils literal">python3</tt>:</p>
<pre class="code python literal-block">
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">absolute_import</span>

<span class="k">def</span> <span class="nf">upper</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;
    Convert `s` to upper case.

    &gt;&gt;&gt; upper('Hello!')
    u'HELLO!'
    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</pre>
<p>Python 3 complains:</p>
<pre class="literal-block">
Failed example:
    upper('Hello!')
Expected:
    u'HELLO!'
Got:
    'HELLO!'
</pre>
<p>The <span>&#8230;<a href="/blog/2016/04/05/DoctestsUnicodeLiteralsPython2_3Compat.html" class="continue">continue</a>.</span></p>
    <footer>
        
        
            <p>tagged as
                <a href="/tag/python/" rel="tag">python</a>
                    and
                    
                <a href="/tag/til/" rel="tag">til</a>
                
            </p>
        
    </footer>
    <div class="comments"></div>
</article>


    
        <article>
    <header>
        <time datetime="2016-03-25">2016-03-25</time>
        <h1>
            <a href="/blog/2016/03/25/Profiling.html" rel="bookmark canonical">Profiling</a>
        </h1>
    </header>
    <p>Despite being a <em>bona fide</em> per&shy;for&shy;mance expert—I spent a couple of years as the Per&shy;for&shy;mance Lead
for Mi&shy;crosoft&shy;'s IIS web server product about 15 years ago—I still forget to measure rather than assume.</p>
<p>I wrote some code today that imported nearly 300,000 nodes into a graph
from a 500MB XML file.
The code was not par&shy;tic&shy;u&shy;lar&shy;ly fast and I assumed that it was the XML parser.
I had been using the built-in streaming parser, <a class="reference external" href="https://docs.python.org/2/library/xml.etree.elementtree.html#xml.etree.ElementTree.iterparse">cEle&shy;ment&shy;Tree iterparse</a>.
I assumed that using the <a class="reference external" href="http://lxml.de/api/lxml.etree.iterparse-class.html">lmxl iterparse</a> would make the code faster.
It didn't.</p>
<p>Then I had the bright idea of tem&shy;porar&shy;i&shy;ly disabling the per-node processing,
which left only the XML parsing.
Instead of <span>&#8230;<a href="/blog/2016/03/25/Profiling.html" class="continue">continue</a>.</span></p>
    <footer>
        
        
            <p>tagged as
                <a href="/tag/performance/" rel="tag">performance</a>,
                <a href="/tag/python/" rel="tag">python</a>
                    and
                    
                <a href="/tag/til/" rel="tag">til</a>
                
            </p>
        
    </footer>
    <div class="comments"></div>
</article>


    
        <article>
    <header>
        <time datetime="2016-03-24">2016-03-24</time>
        <h1>
            <a href="/blog/2016/03/24/RaisingIOErrorForFileNotFound.html" rel="bookmark canonical">Raising IOError for 'file not found'</a>
        </h1>
    </header>
    <p>I wanted to raise Python's <a class="reference external" href="https://docs.python.org/2/library/exceptions.html#exceptions.IOError">IOError</a> for a file-not-found condition,
but it wasn't obvious what the parameters to the exception should be.</p>
<pre class="code python literal-block">
<span class="kn">from</span> <span class="nn">errno</span> <span class="kn">import</span> <span class="n">ENOENT</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">source_file</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="n">ENOENT</span><span class="p">,</span> <span class="s1">'Not a file'</span><span class="p">,</span> <span class="n">source_file</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">source_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre>
<p><tt class="docutils literal">IOError</tt> can be in&shy;stan&shy;ti&shy;at&shy;ed with 1, 2, or 3 arguments:</p>
<dl class="docutils">
<dt><tt class="docutils literal">IOError(errno, strerror, filename)</tt></dt>
<dd>These arguments are available
on the <tt class="docutils literal">errno</tt>, <tt class="docutils literal">strerror</tt>, and <tt class="docutils literal">filename</tt> attributes of the exception object,
re&shy;spec&shy;tive&shy;ly, in both Python 2 and 3.
The <tt class="docutils literal">args</tt> attribute contains the verbatim con&shy;struc&shy;tor arguments as a tuple.</dd>
<dt><tt class="docutils literal">IOError(errno, strerror)</tt></dt>
<dd>These are available on the <tt class="docutils literal">errno</tt> and <tt class="docutils literal">strerror</tt> attributes of the exception,
re&shy;spec&shy;tive&shy;ly, in both Python 2 and <span>&#8230;<a href="/blog/2016/03/24/RaisingIOErrorForFileNotFound.html" class="continue">continue</a>.</span></dd></dl>
    <footer>
        
        
            <p>tagged as
                <a href="/tag/python/" rel="tag">python</a>
                    and
                    
                <a href="/tag/til/" rel="tag">til</a>
                
            </p>
        
    </footer>
    <div class="comments"></div>
</article>


    
    
        <a href="/tag/python/3/" class="page floatright">
        Previous &raquo;
        </a>
    
    
        <a href="/tag/python/" class="page floatleft">
        &laquo; Next
        </a>
<footer>
    
    
    <p>written by <a href="mailto:george@reilly.org">George V. Reilly</a></p>
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="copyright license">
        <img src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" alt="by-nc-sa" />
    </a>
    <script data-goatcounter="https://georgevreilly.goatcounter.com/count"
            async src="//gc.zgo.at/count.js"></script>
    
    

  </footer>
</body>
</html>
