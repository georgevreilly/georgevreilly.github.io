<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>George V. Reilly</title>
  <link media="all" href="/style.css" rel="stylesheet" />
  <link media="all" href="/pygments.css" rel="stylesheet" />
  <link href="/favicon.ico" rel="shortcut icon" />
    <link href="/sitemap.xml" type="application/xml" rel="sitemap" title="Sitemap">
  <link href="/" rel="home start" />
  <link href="/atom/" type="application/atom+xml" rel="alternate" title="Atom Feed" />
  <link href="/rss/" type="application/rss+xml" rel="alternate" title="RSS Feed" />
</head>
<body>
  <header>
    <h1><a href="/" rel="home start" class="blogtitle">George V. Reilly</a></h1>
    <nav>
      <ul>
        <li><a href="/blog/" rel="home start" title="George's full blog">blog</a></li>
        <li><a href="/til/" rel="home start" title="Today George Learned">TIL</a></li>
        <li><a href="/about/" rel="home start" title="About George">about</a></li>
        <li><a href="/atom/" rel="alternate" title="Atom Feed">atom</a></li>
        <li><a href="/rss/" rel="alternate" title="RSS Feed">rss</a></li>
        <li><a href="/articles/" rel="contents">articles</a></li>
        <li><a href="/tags/" rel="contents">tags</a></li>
      </ul>
    </nav>
  </header>
    
        <article>
    <header>
        <time datetime="2022-01-31">2022-01-31</time>
        <h1>
            <a href="/blog/2022/01/31/DiffFileFragment.html" rel="bookmark canonical">Diffing a fragment of a file</a>
        </h1>
    </header>
    <p>A while back, I had extracted some code out of a large file
into a separate file and made some mod­i­fi­ca­tions.
I wanted to check that the dif­fer­ences were minimal.
Let's say that the extracted code had been between
lines 123 and 456 of <tt class="docutils literal">large_old_­file</tt>.</p>
<pre class="code bash literal-block">
diff -u <<span class="o">(</span>sed -n <span class="s1">'123,456p;457q'</span> large_old_file<span class="o">)</span> new_file
</pre>
<p>What's happening here?</p>
<ul class="simple">
<li><tt class="docutils literal">sed <span class="pre">-n</span> '123,456p'</tt> is printing lines 123–456 of <tt class="docutils literal">large_old_­file</tt>.</li>
<li>The <tt class="docutils literal">457q</tt> tells sed to abandon the file at line 457.
Otherwise, it will keep reading all the way to the end.</li>
<li>The <tt class="docutils literal"><(sed <span class="pre">...)</span></tt> is an example of <a class="reference external" href="https://tldp.org/LDP/abs/html/process-sub.html">process sub­sti­tu­tion</a>.
The <em>output</em> of the <tt class="docutils literal">sed</tt> invocation
becomes the first <em>input</em> of the <tt class="docutils literal">diff</tt> command.</li>
</ul>
<p>A similar example: <a class="reference external" href="/blog/2017/01/11/DiffTransformedFile.html">Diff </a><span>&#8230;<a href="/blog/2022/01/31/DiffFileFragment.html" class="continue">continue</a>.</span></p>
    <footer>
        
        
            <p>tagged as
                <a href="/tag/programming/" rel="tag">programming</a>
                    and
                    
                <a href="/tag/bash/" rel="tag">bash</a>
                
            </p>
        
    </footer>
    <div class="comments"></div>
</article>


    
        <article>
    <header>
        <time datetime="2017-01-19">2017-01-19</time>
        <h1>
            <a href="/blog/2017/01/19/BashEchoSuccessOfPreviousCommand.html" rel="bookmark canonical">Bash: echo success of previous command</a>
        </h1>
    </header>
    <p>C-like languages have a ternary operator,
<tt class="docutils literal">cond ? true_re­sult : false_re­sult</tt>.
Python has <tt class="docutils literal">true_re­sult if cond else false_re­sult</tt>.
Bash doesn't have a ternary operator, but there are <a class="reference external" href="http://stackoverflow.com/a/3953712/6364">various workarounds</a>.</p>
<p>I wanted to print <tt class="docutils literal">succeeded</tt> or <tt class="docutils literal">failed</tt>
based on the exit code of the previous command
in a shell script.
In Unix, all programs exit with an integer status code.
Successful programs exit with <tt class="docutils literal">0</tt>;
all other values, positive or negative, indicate <a class="reference external" href="http://www-numi.fnal.gov/offline_software/srt_public_context/WebDocs/Errors/unix_system_errors.html">failure</a>.
In Bash, the <a class="reference external" href="http://tldp.org/LDP/abs/html/exit-status.html">status code</a> of the previous program is held in <tt class="docutils literal">$?</tt>.</p>
<pre class="code bash literal-block">
some/command or-other fer example

<span class="nv">STATUS</span><span class="o">=</span><span class="s2">"</span><span class="k">$(</span><span class="o">[</span> <span class="s2">"</span><span class="nv">$?</span><span class="s2">"</span> <span class="o">==</span> <span class="m">0</span> <span class="o">]</span> <span class="o">&&</span> <span class="nb">echo</span> <span class="s1">'succeeded'</span> <span class="o">||</span> <span class="nb">echo</span> <span class="s1">'failed'</span><span class="k">)</span><span class="s2">"</span>
<span class="nb">echo</span> <span class="s2">"Results: </span><span class="nv">$STATUS</span><span class="s2">"</span>
</pre>
<p>There are <a class="reference external" href="http://stackoverflow.com/a/3953712/6364">other ways</a> to handle this.</p>

    <footer>
        
        
            <p>tagged as
                <a href="/tag/bash/" rel="tag">bash</a>
                
            </p>
        
    </footer>
    <div class="comments"></div>
</article>


    
        <article>
    <header>
        <time datetime="2017-01-11">2017-01-11</time>
        <h1>
            <a href="/blog/2017/01/11/DiffTransformedFile.html" rel="bookmark canonical">Diff a Transformed File</a>
        </h1>
    </header>
    <p>I wanted to diff two files.
One of them needed some <tt class="docutils literal">sed</tt>s on each line and sorting.
I wanted to do that on the fly,
without leaving a massaged in­ter­me­di­ate file lying around.</p>
<pre class="code bash literal-block">
colordiff --unified <<span class="o">(</span>cat orphaned_permalinks.txt
                        <span class="p">|</span> sed <span class="s1">'s@http://www.georgevreilly.com/@@'</span>
                        <span class="p">|</span> sed <span class="s1">'s/.aspx$/.html/'</span>
                </pre><span>&#8230;<a href="/blog/2017/01/11/DiffTransformedFile.html" class="continue">continue</a>.</span>
    <footer>
        
        
            <p>tagged as
                <a href="/tag/programming/" rel="tag">programming</a>
                    and
                    
                <a href="/tag/bash/" rel="tag">bash</a>
                
            </p>
        
    </footer>
    <div class="comments"></div>
</article>


    
        <article>
    <header>
        <time datetime="2016-07-06">2016-07-06</time>
        <h1>
            <a href="/blog/2016/07/06/BashBulkRenaming.html" rel="bookmark canonical">Bash: Bulk Renaming</a>
        </h1>
    </header>
    <p>I had to rename several hundred thousand files today.
Thanks to a botched invocation of Im­ageMag­ick,
they all looked like <tt class="docutils literal">unique_pre­fix.png.jpg</tt>,
whereas we simply wanted <tt class="docutils literal">unique_pre­fix.jpg</tt>.</p>
<p>I found a <a class="reference external" href="http://unix.stackexchange.com/a/102653/4060">suitable answer at the Unix Stack­Ex­change</a>.
As one of the many variants of <a class="reference external" href="http://tldp.org/LDP/abs/html/parameter-substitution.html">parameter sub­sti­tu­tion</a>,
Bash supports <tt class="docutils literal">${var/Pattern/Re­place­men­t}</tt>:
“first match of <tt class="docutils literal">Pattern</tt> within <tt class="docutils literal">var</tt> replaced with <tt class="docutils literal">Re­place­ment</tt>.”</p>
<pre class="code bash literal-block">
<span class="k">for</span> f <span class="k">in</span> *.png.jpg<span class="p">;</span>
<span class="k">do</span>
    mv <span class="nv">$f</span> <span class="s2">"</span><span class="si">${</span><span class="nv">f</span><span class="p">/.png</span><span class="si">}</span><span class="s2">"</span>
<span class="k">done</span>
</pre>
<p>The target expression could also have been written as <tt class="docutils literal"><span class="pre">"${f/.png.jpg/.jpg}"</span></tt></p>

    <footer>
        
        
            <p>tagged as
                <a href="/tag/bash/" rel="tag">bash</a>
                
            </p>
        
    </footer>
    <div class="comments"></div>
</article>


    
        <article>
    <header>
        <time datetime="2016-03-17">2016-03-17</time>
        <h1>
            <a href="/blog/2016/03/17/QuotingInBash.html" rel="bookmark canonical">Quoting in Bash</a>
        </h1>
    </header>
    <p>Various Bash guides recommend putting quotes around just about everything.
I had a script that contained this line:</p>
<pre class="code bash literal-block">
sudo apt-get install --yes <span class="k">$(</span>cat <span class="s2">"</span><span class="nv">$BUILD</span><span class="s2">/install_on_aws_ubuntu.txt"</span><span class="k">)</span>
</pre>
<p>While refac­tor­ing, I put another set of quotes around the <tt class="docutils literal">$(cat <span class="pre">...)</span></tt>
out of an abundance of caution:</p>
<pre class="code bash literal-block">
sudo apt-get install --yes <span class="s2">"</span><span class="k">$(</span>cat <span class="s2">"</span><span class="nv">$BUILD</span><span class="s2">/install_on_aws_ubuntu.txt"</span><span class="k">)</span><span class="s2">"</span>
</pre>
<p>Several other changes later, I couldn't figure out why my script had stopped working.</p>
<p>Here's what happened:</p>
<pre class="code bash literal-block">
$ cat <span class="nv">$HOME</span>/tmp/demo.txt
foo
bar
quux

$ <span class="nb">echo</span> <span class="k">$(</span>cat <span class="s2">"</span><span class="nv">$HOME</span><span class="s2">/tmp/demo.txt"</span><span class="k">)</span>
foo bar quux

$ <span class="nb">echo</span> <span class="s2">"</span><span class="k">$(</span>cat <span class="nv">$HOME</span>/tmp/demo.txt<span class="k">)</span><span class="s2">"</span>
foo
bar
quux
</pre>
<p>The new outer quotes retained the newlines;
the original replaced newlines with spaces.</p>
<p>The <a class="reference external" href="http://mywiki.wooledge.org/BashFAQ">Bash FAQ</a> has more: specif­i­cal­ly <a class="reference external" href="http://mywiki.wooledge.org/CommandSubstitution">Command Substition</a> and <a class="reference external" href="http://mywiki.wooledge.org/WordSplitting">Word Splitting</a>.</p>

    <footer>
        
        
            <p>tagged as
                <a href="/tag/bash/" rel="tag">bash</a>
                
            </p>
        
    </footer>
    <div class="comments"></div>
</article>


    
        <article>
    <header>
        <time datetime="2016-01-12">2016-01-12</time>
        <h1>
            <a href="/blog/2016/01/12/BashGettingAndSettingDefaultValues.html" rel="bookmark canonical">Bash: Getting and Setting Default Values</a>
        </h1>
    </header>
    <p>Bash has some handy syntax for getting and setting default values.
Un­for­tu­nate­ly, it's a collection of punc­tu­a­tion characters,
which makes it hard to Google when you can't quite remember the syntax.</p>
<p>Getting a default value using <tt class="docutils literal"><span class="pre">${var:-fallback}</span></tt>:</p>
<pre class="code bash literal-block">
<span class="c1"># set $LOGDIR to $1 if $1 has a value; otherwise set $LOGDIR to "/var/log"
</span><span class="nv">LOGDIR</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">1</span><span class="k">:-</span><span class="p">/var/log</span><span class="si">}</span><span class="s2">"</span>

<span class="c1"># use $VERSION unless it's empty or unset; fall back to extracting someprog's version num
</span><span class="nv">build_version</span><span class="o">=</span><span class="si">${</span><span class="nv">VERSION</span><span class="k">:-$(</span>someprog --version <span class="p">|</span> sed <span class="s1">'s/[^0-9.]*\([0-9.]*\).*/\1/'</span><span class="k">)</span><span class="si">}</span>
</pre>
<p>The colon-dash con­struc­tion is known as the
<a class="reference external" href="https://en.wikipedia.org/wiki/Dog%27s_bollocks_(typography)">dog's bollocks</a>
in typography.</p>
<p>Setting a default value, using <tt class="docutils literal"><span class="pre">${var:=fallback}</span></tt>:</p>
<pre class="code bash literal-block">
$ <span class="nb">echo</span> <span class="nv">$HOME</span>
/Users/georgevreilly
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">HOME</span><span class="p">:=/tmp</span><span class="si">}</span>
/Users/georgevreilly
$ <span class="nb">unset</span> HOME
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">HOME</span><span class="p">:=/tmp</span><span class="si">}</span>
/tmp
$ <span class="nb">echo</span> <span class="nv">$HOME</span>
/tmp
$ cd<span class="p">;</span> <span class="nb">pwd</span>
/tmp
</pre>
<p>Note: <tt class="docutils literal">:=</tt> uses the new value in two cases.
First, when <span>&#8230;<a href="/blog/2016/01/12/BashGettingAndSettingDefaultValues.html" class="continue">continue</a>.</span></p>
    <footer>
        
        
            <p>tagged as
                <a href="/tag/bash/" rel="tag">bash</a>
                
            </p>
        
    </footer>
    <div class="comments"></div>
</article>


    
        <article>
    <header>
        <time datetime="2015-12-23">2015-12-23</time>
        <h1>
            <a href="/blog/2015/12/23/ParseMinVerBash.html" rel="bookmark canonical">Checking minimum version numbers in Bash</a>
        </h1>
    </header>
    <a class="reference external image-reference" href="http://cube-drone.com/comics/c/version-sacrifice"></a>
<p>I worked on a Bash script today that sets up various pre­req­ui­sites for our build.
We need a recent version of Docker
but our <a class="reference external" href="https://www.atlassian.com/software/bamboo/">Bamboo</a> build agents are running on Ubuntu 14.04,
which has a very old version of Docker.
The script upgrades Docker when it's first run.
The script may be run more than once during the lifetime of the agent,
so the second and subsequent calls should not upgrade Docker.</p>
<p>Basically, I wanted</p>
<pre class="code bash literal-block">
<span class="k">if</span> <span class="nv">$DOCKER_VERSION</span> < <span class="m">1</span>.9<span class="p">;</span> <span class="k">then</span> upgrade_docker<span class="p">;</span> <span class="k">fi</span>
</pre>
<p>Un­for­tu­nate­ly, it's not that easy in Bash.
Here's what I came up with.</p>
<pre class="code bash literal-block">
install_latest_docker<span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> docker --version <span class="p">|</span> python -c <span class="s2">"min=[1, 9]; import sys; ↩
v=[int(x) </span></pre><span>&#8230;<a href="/blog/2015/12/23/ParseMinVerBash.html" class="continue">continue</a>.</span>
    <footer>
        
        
            <p>tagged as
                <a href="/tag/bash/" rel="tag">bash</a>
                    and
                    
                <a href="/tag/python/" rel="tag">python</a>
                
            </p>
        
    </footer>
    <div class="comments"></div>
</article>


    
    
    
<footer>
    
    
    <p>written by <a href="mailto:george@reilly.org">George V. Reilly</a></p>
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="copyright license">
        <img src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" alt="by-nc-sa" />
    </a>
    
    

  </footer>
</body>
</html>
