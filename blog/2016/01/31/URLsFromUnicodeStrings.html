<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>URLs from Unicode Strings</title>
  <link media="all" href="/style.css" rel="stylesheet" />
  <link media="all" href="/pygments.css" rel="stylesheet" />
  <link href="/favicon.ico" rel="shortcut icon" />
    <link href="/sitemap.xml" type="application/xml" rel="sitemap" title="Sitemap">
  <link href="/" rel="home start" />
  <link href="/atom/" type="application/atom+xml" rel="alternate" title="Atom Feed" />
  <link href="/rss/" type="application/rss+xml" rel="alternate" title="RSS Feed" />
    <meta name="description" content="\ 

    [Previously published at the now defunct `..." />
    <meta name="keywords" content="unicode, urls, metabrite" />
</head>
<body>
  <header>
    <h1><a href="/" rel="home start" class="blogtitle">George V. Reilly</a></h1>
    <nav>
      <ul>
        <li><a href="/blog/" rel="home start">blog</a></li>
        <li><a href="/about/" rel="home start">about</a></li>
        <li><a href="/atom/" rel="alternate">atom</a></li>
        <li><a href="/rss/" rel="alternate">rss</a></li>
        <li><a href="/articles/" rel="contents">articles</a></li>
        <li><a href="/tags/" rel="contents">tags</a></li>
      </ul>
    </nav>
  </header>
    
        <article>
    <header>
        <time datetime="2016-01-31">2016-01-31</time>
        <h1>
            <a href="/blog/2016/01/31/URLsFromUnicodeStrings.html" rel="bookmark canonical">URLs from Unicode Strings</a>
        </h1>
    </header>
    <p></p>
<blockquote>
[Pre&shy;vi&shy;ous&shy;ly published at the now defunct <a class="reference external" href="https://web.archive.org/web/20171001220321/http://devblog.metabrite.com/">MetaBrite Dev Blog</a>.]</blockquote>
<p>Some time ago,
we made an ill-considered decision to use recipe names for image URLs,
which simplified image management with our then-rudi&shy;men&shy;ta&shy;ry tools.
For example, the recipe named
<tt class="docutils literal">"Twisted Pasta With Browned Butter, Sage, and Walnuts"</tt>
becomes a <span class="caps">URL</span> ending in
<tt class="docutils literal">"Twist&shy;ed%20&shy;Pas&shy;ta%20With&shy;%20Browned%20But&shy;ter%2C%20Sage%2C%20and%20Wal&shy;nuts.jpg"</tt>.</p>
<p>Life becomes more in&shy;ter&shy;est&shy;ing when you escape the confines of 7-bit <span class="caps">ASCII</span> and use Unicode.
How should <tt class="docutils literal">u"Sautéed crème fraîche Provençale"</tt> be handled?
The only reasonable thing to do is to first convert the Unicode string to <span class="caps">UTF</span>-8
and then hex-encode those octets:
<tt class="docutils literal">"Saut%C3%A9ed%20cr%C3%A8me%20fra%C3%AEche%20Proven%C3%A7ale"</tt>.</p>
<p>That seems reasonable, but it was giving us in&shy;con&shy;sis&shy;tent results
when the images were uploaded to an S3 bucket.
When I in&shy;ves&shy;ti&shy;gat&shy;ed, I discovered that it was a problem of <a class="reference external" href="https://en.wikipedia.org/wiki/Unicode_equivalence">Unicode equiv&shy;a&shy;lence</a>.
There are two ways to represent,
say, the <em>e-acute</em> character in Unicode:
as a composed character,
<tt class="docutils literal">é</tt> = ‘<span class="caps">LATIN</span> <span class="caps">SMALL</span> <span class="caps">LETTER</span> E <span class="caps">WITH</span> <span class="caps">ACUTE</span>’ <tt class="docutils literal">(U+00E9)</tt>,
or as a decomposed pair,
<tt class="docutils literal">e´</tt> = ‘<span class="caps">LATIN</span> <span class="caps">SMALL</span> <span class="caps">LETTER</span> E’ <tt class="docutils literal">(U+0065)</tt> and ‘<span class="caps">COMBINING</span> <span class="caps">ACUTE</span> <span class="caps">ACCENT</span>’ <tt class="docutils literal">(U+0301)</tt>.
Thus the name of our fictitious recipe can be rep&shy;re&shy;sent&shy;ed as
<tt class="docutils literal">u"Saut\u00E9ed cr\u00E8me fra\u00EEche Proven\u00E7ale"</tt> (composed, <span class="caps">NFC</span>) <em>or</em>
<tt class="docutils literal">u"Saute\u0301ed cre\u0300me frai\u0302che Provenc\u0327ale"</tt> (decomposed, <span class="caps">NFD</span>).</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%"/>
<col width="19%"/>
<col width="14%"/>
<col width="31%"/>
<col width="21%"/>
</colgroup>
<thead valign="bottom">
<tr><th class="head">Letter</th>
<th class="head">Composed</th>
<th class="head"><span class="caps">UTF</span>-8</th>
<th class="head">Decomposed</th>
<th class="head"><span class="caps">UTF</span>-8</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><tt class="docutils literal">é</tt></td>
<td>U+00E9</td>
<td>C3 A9</td>
<td>U+0065 U+0301</td>
<td>65 <span class="caps">CC</span> 81</td>
</tr>
<tr><td><tt class="docutils literal">è</tt></td>
<td>U+00E8</td>
<td>C3 A8</td>
<td>U+0065 U+0300</td>
<td>65 <span class="caps">CC</span> 80</td>
</tr>
<tr><td><tt class="docutils literal">î</tt></td>
<td>U+<span class="caps">00EE</span></td>
<td>C3 <span class="caps">AE</span></td>
<td>U+0069 U+0302</td>
<td>69 <span class="caps">CC</span> 82</td>
</tr>
<tr><td><tt class="docutils literal">ç</tt></td>
<td>U+00E7</td>
<td>C3 A7</td>
<td>U+0063 U+0327</td>
<td>63 <span class="caps">CC</span> A7</td>
</tr>
</tbody>
</table>
<p>When we uploaded our image files to S3 from a Mac,
accented letters were decomposed let&shy;ter–ac&shy;cent pairs,
while images uploaded from Linux had composed characters in their S3 key names.
This dis&shy;crep&shy;an&shy;cy was due to the Mac <span class="caps">HFS</span>+ filesystem,
which stores filenames in decomposed form.
(Linus Torvalds has a profane <a class="reference external" href="https://archive.ph/VaX6k">rant about <span class="caps">HFS</span>+</a>.)
Our client apps always used the composed form of the recipe name
and generated image URLs ac&shy;cord&shy;ing&shy;ly.
This led to 404s for recipe images that had been uploaded from a Mac.
If S3 had handled the Unicode equiv&shy;a&shy;lence, we’d never have noticed.</p>
<p>We’re switching to using numeric iden&shy;ti&shy;fiers for the recipe im&shy;ages—they’re much harder to get wrong.</p>

    <footer>
        
        
            <p>tagged as
                <a href="/tag/unicode/" rel="tag">unicode</a>,
                <a href="/tag/urls/" rel="tag">urls</a>
                    and
                    
                <a href="/tag/metabrite/" rel="tag">metabrite</a>
                
            </p>
        
    </footer>
    <div class="comments">
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = 'georgevreilly'; // required: replace example with your forum shortname

            // The following are highly recommended additional parameters. Remove the slashes in front to use.
            var disqus_identifier = "https://www.georgevreilly.com/blog/2016/01/31/URLsFromUnicodeStrings.html";
            var disqus_url = "https://www.georgevreilly.com/blog/2016/01/31/URLsFromUnicodeStrings.html";

            if (window.location.hostname != "localhost") {
                /* * * DON'T EDIT BELOW THIS LINE * * */
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            }
        </script>
        <noscript>
            <p>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></p>
        </noscript>
        <a href="https://disqus.com" class="dsq-brlink">
            blog comments powered by <span class="logo-disqus">Disqus</span>
        </a>
        </div>
</article>


    
    
        <a href="/blog/2016/01/30/ReviewTheBuglesBlowing.html" class="page floatright">
        Review: The Bugles Blowing &raquo;
        </a>
    
    
        <a href="/blog/2016/02/01/ToastmastersContestChair.html" class="page floatleft">
        &laquo; Toastmasters Contest Chair
        </a>
<footer>
    
    
    <p>written by <a href="mailto:george@reilly.org">George V. Reilly</a></p>
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="copyright license">
        <img src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" alt="by-nc-sa" />
    </a>
    
    

  </footer>
</body>
</html>
