<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Checking minimum version numbers in Bash</title>
  <link media="all" href="/style.css" rel="stylesheet" />
  <link media="all" href="/pygments.css" rel="stylesheet" />
  <link href="/favicon.ico" rel="shortcut icon" />
    <link href="/sitemap.xml" type="application/xml" rel="sitemap" title="Sitemap">
  <link href="/" rel="home start" />
  <link href="/atom/" type="application/atom+xml" rel="alternate" title="Atom Feed" />
  <link href="/rss/" type="application/rss+xml" rel="alternate" title="RSS Feed" />
    <meta name="description" content=".. image:: https://cube-drone.com/media/optimized/..." />
    <meta name="keywords" content="bash, python" />
</head>
<body>
  <header>
    <h1><a href="/" rel="home start" class="blogtitle">George V. Reilly</a></h1>
    <nav>
      <ul>
        <li><a href="/blog/" rel="home start" title="George's full blog">blog</a></li>
        <li><a href="/til/" rel="home start" title="Today George Learned">TIL</a></li>
        <li><a href="/about/" rel="home start" title="About George">about</a></li>
        <li><a href="/atom/" rel="alternate" title="Atom Feed">atom</a></li>
        <li><a href="/rss/" rel="alternate" title="RSS Feed">rss</a></li>
        <li><a href="/articles/" rel="contents">articles</a></li>
        <li><a href="/tags/" rel="contents">tags</a></li>
      </ul>
    </nav>
  </header>
    
        <article>
    <header>
        <time datetime="2015-12-23">2015-12-23</time>
        <h1>
            <a href="/blog/2015/12/23/ParseMinVerBash.html" rel="bookmark canonical">Checking minimum version numbers in Bash</a>
        </h1>
    </header>
    <a class="reference external image-reference" href="http://cube-drone.com/comics/c/version-sacrifice"><img alt="Version Sacrifice" src="https://cube-drone.com/media/optimized/161.png"/></a>
<p>I worked on a Bash script today that sets up various pre&shy;req&shy;ui&shy;sites for our build.
We need a recent version of Docker
but our <a class="reference external" href="https://www.atlassian.com/software/bamboo/">Bamboo</a> build agents are running on Ubuntu 14.04,
which has a very old version of Docker.
The script upgrades Docker when it’s first run.
The script may be run more than once during the lifetime of the agent,
so the second and subsequent calls should not upgrade Docker.</p>
<p>Basically, I wanted</p>
<pre class="code bash literal-block">
<span class="k">if</span> <span class="nv">$DOCKER_VERSION</span> < <span class="m">1</span>.9<span class="p">;</span> <span class="k">then</span> upgrade_docker<span class="p">;</span> <span class="k">fi</span>
</pre>
<p>Un&shy;for&shy;tu&shy;nate&shy;ly, it’s not that easy in Bash.
Here’s what I came up with.</p>
<pre class="code bash literal-block">
install_latest_docker<span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> docker --version <span class="p">|</span> python -c <span class="s2">"min=[1, 9]; import sys; ↩
v=[int(x) for x in sys.stdin.read().split()[2].split(',')[0].split('.')]; ↩
sys.exit(v < min)"</span><span class="p">;</span>
    <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">"Docker up to date"</span>
        <span class="k">return</span>
    <span class="k">fi</span>
    <span class="c1"># Install Docker ...</span>
</pre>
<p>Let’s unpack that ugly <tt class="docutils literal">if</tt> one-liner.
Note: the <tt class="docutils literal">↩</tt> denotes linebreaks introduced for pre&shy;sen&shy;ta&shy;tion purposes; it’s all one line.</p>
<pre class="code bash literal-block">
$ docker --version
Docker version <span class="m">1</span>.9.1, build a34a1d5
</pre>
<pre class="code python literal-block">
<span class="err">$</span> <span class="n">ipython</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">dv</span> <span class="o">=</span> <span class="s1">'Docker version 1.9.1, build a34a1d5'</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">dv</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="p">[</span><span class="s1">'Docker'</span><span class="p">,</span> <span class="s1">'version'</span><span class="p">,</span> <span class="s1">'1.9.1,'</span><span class="p">,</span> <span class="s1">'build'</span><span class="p">,</span> <span class="s1">'a34a1d5'</span><span class="p">]</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="n">dv</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="s1">'1.9.1,'</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="c1"># Remove trailing comma</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="n">dv</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">','</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="p">[</span><span class="s1">'1.9.1'</span><span class="p">,</span> <span class="s1">''</span><span class="p">]</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="n">dv</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">','</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="s1">'1.9.1'</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="c1"># Break apart at dots</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="n">dv</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">','</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'.'</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="p">[</span><span class="s1">'1'</span><span class="p">,</span> <span class="s1">'9'</span><span class="p">,</span> <span class="s1">'1'</span><span class="p">]</span>

<span class="c1"># String comparisons aren't good enough for version numbers</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="p">[</span><span class="s1">'1'</span><span class="p">,</span> <span class="s1">'10'</span><span class="p">]</span> <span class="o"><</span> <span class="p">[</span><span class="s1">'1'</span><span class="p">,</span> <span class="s1">'9'</span><span class="p">]</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="kc">True</span>

<span class="c1"># We have to convert each token to an integer, then lexicographically compare</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">10</span><span class="p">]:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span> <span class="o"><</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">10</span><span class="p">]:</span> <span class="kc">False</span>

<span class="c1"># Convert to list of integers</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">11</span><span class="p">]:</span> <span class="n">version</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dv</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">','</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'.'</span><span class="p">)]</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">12</span><span class="p">]:</span> <span class="nb">min</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">13</span><span class="p">]:</span> <span class="n">version</span><span class="p">,</span> <span class="nb">min</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">13</span><span class="p">]:</span> <span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="p">])</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">14</span><span class="p">]:</span> <span class="n">version</span> <span class="o"><</span> <span class="nb">min</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">14</span><span class="p">]:</span> <span class="kc">False</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">15</span><span class="p">]:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o"><</span> <span class="nb">min</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">15</span><span class="p">]:</span> <span class="kc">True</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">16</span><span class="p">]:</span> <span class="nb">int</span><span class="p">(</span><span class="n">version</span> <span class="o"><</span> <span class="nb">min</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">16</span><span class="p">]:</span> <span class="mi">0</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">17</span><span class="p">]:</span> <span class="nb">int</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o"><</span> <span class="nb">min</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">17</span><span class="p">]:</span> <span class="mi">1</span>
</pre>
<p>The ugly triple split inside the list com&shy;pre&shy;hen&shy;sion
produces a list of integers,
which can be compared lex&shy;i&shy;co&shy;graph&shy;i&shy;cal&shy;ly against
<tt class="docutils literal">min</tt>, another list.
<tt class="docutils literal">sys.exit</tt> is called with <tt class="docutils literal">1</tt> when Docker’s version is less than <tt class="docutils literal">min</tt>.</p>
<p>When <tt class="docutils literal">$?</tt> is non-zero in Bash, then <tt class="docutils literal">if some_&shy;com&shy;mand</tt> fails
and the <tt class="docutils literal">else</tt> clause (none here) is executed.</p>
<p>I came across <a class="reference external" href="http://python-oneliner.readthedocs.org/en/latest/">Python Oneliner</a>, while debugging my script.
I might use Oneliner in other cir&shy;cum&shy;stances.</p>

    <footer>
        
        
            <p>tagged as
                <a href="/tag/bash/" rel="tag">bash</a>
                    and
                    
                <a href="/tag/python/" rel="tag">python</a>
                
            </p>
        
    </footer>
    <div class="comments">
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = 'georgevreilly'; // required: replace example with your forum shortname

            // The following are highly recommended additional parameters. Remove the slashes in front to use.
            var disqus_identifier = "https://www.georgevreilly.com/blog/2015/12/23/ParseMinVerBash.html";
            var disqus_url = "https://www.georgevreilly.com/blog/2015/12/23/ParseMinVerBash.html";

            if (window.location.hostname != "localhost") {
                /* * * DON'T EDIT BELOW THIS LINE * * */
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            }
        </script>
        <noscript>
            <p>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></p>
        </noscript>
        <a href="https://disqus.com" class="dsq-brlink">
            blog comments powered by <span class="logo-disqus">Disqus</span>
        </a>
        </div>
</article>


    
    
        <a href="/blog/2015/12/22/ChristmasCake.html" class="page floatright">
        Christmas Cake &raquo;
        </a>
    
    
        <a href="/blog/2015/12/24/Running.html" class="page floatleft">
        &laquo; Running
        </a>
<footer>
    
    
    <p>written by <a href="mailto:george@reilly.org">George V. Reilly</a></p>
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="copyright license">
        <img src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" alt="by-nc-sa" />
    </a>
    
    

  </footer>
</body>
</html>
