<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Path Traversal Attacks</title>
  <link media="all" href="/style.css" rel="stylesheet" />
  <link media="all" href="/pygments.css" rel="stylesheet" />
  <link href="/favicon.ico" rel="shortcut icon" />
    <link href="/sitemap.xml" type="application/xml" rel="sitemap" title="Sitemap">
  <link href="/" rel="home start" />
  <link href="/atom/" type="application/atom+xml" rel="alternate" title="Atom Feed" />
  <link href="/rss/" type="application/rss+xml" rel="alternate" title="RSS Feed" />
    <meta name="description" content="I was surprised to read this evening that the Apac..." />
    <meta name="keywords" content="iis, security, unicode" />
</head>
<body>
  <header>
    <h1><a href="/" rel="home start" class="blogtitle">George V. Reilly</a></h1>
    <nav>
      <ul>
        <li><a href="/blog/" rel="home start" title="George's full blog">blog</a></li>
        <li><a href="/til/" rel="home start" title="Today George Learned">TIL</a></li>
        <li><a href="/about/" rel="home start" title="About George">about</a></li>
        <li><a href="/atom/" rel="alternate" title="Atom Feed">atom</a></li>
        <li><a href="/rss/" rel="alternate" title="RSS Feed">rss</a></li>
        <li><a href="/articles/" rel="contents">articles</a></li>
        <li><a href="/tags/" rel="contents">tags</a></li>
      </ul>
    </nav>
  </header>
    
        <article>
    <header>
        <time datetime="2021-10-05">2021-10-05</time>
        <h1>
            <a href="/blog/2021/10/05/PathTraversalAttacks.html" rel="bookmark canonical">Path Traversal Attacks</a>
        </h1>
    </header>
    <p>I was surprised to read this evening that the Apache Web Server
just fixed an actively exploited path traversal&nbsp;flaw.</p>
<blockquote class="twitter-tweet">
<p lang="en" dir="ltr">
üö® Apache has disclosed an *actively exploited* Path traversal flaw
in the <a href="https://twitter.com/hashtag/opensource?src=hash&amp;ref_src=twsrc%5Etfw">#open&shy;source</a>
&quot;httpd&quot; server.
Over 112,000 exposed Apache servers run version 2.4.49,
and should be upgraded now!<br>
New fix checks for encoded path traversal characters
e.g. /../.%2E/<a href="https://t.co/1tLNc3LAul">https://t.co/1tLNc3LAul</a>
<a href="https://t.co/mDHLEU3k9N">pic.twitter.com/mDHLEU3k9N</a>
</p>&mdash; Ax Sharma (@Ax_Sharma)
<a href="https://twitter.com/Ax_Sharma/status/1445391350053183500?ref_src=twsrc%5Etfw">October 5, 2021</a>
</blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p>Apparently, it was <a class="reference external" href="https://github.com/apache/httpd/commit/4c79fd280dfa3eede5a6f3baebc7ef2e55b3eb6a">introduced over a year ago</a>.</p>
<p>I&#8217;m gobsmacked that Apache didn&#8217;t have a robust suite of tests for&nbsp;this.</p>
<p>Directory Traversal attacks have been a problem for web servers
since the beginning.
<a class="reference external" href="https://owasp.org/www-community/attacks/Path_Traversal"><span class="caps">OWASP</span></a>, <a class="reference external" href="https://portswigger.net/web-security/file-path-traversal">PortSwig&shy;ger</a>, and <a class="reference external" href="https://spanning.com/blog/directory-traversal-web-based-application-security-part-8/">Spanning</a> all have ex&shy;pla&shy;na&shy;tions that you can read.
The essence is that you make a request to a <span class="caps">URL</span> that looks like
<tt class="docutils literal"><span class="pre">http://example.com/cgi-bin/../../../../etc/passwd</span></tt>
and, voil√†, you get access to something that you shouldn&#8217;t.
Each of the <tt class="docutils literal">..</tt> path segments climbs up a level of the file system.
Even the simplest web server knows better than to blindly allow
a sequence of <tt class="docutils literal">..</tt> path segments,
so you have to be a little clever about how you express&nbsp;them.</p>
<div class="section" id="iis-unicode-exploit">
<h2><span class="caps">IIS</span> Unicode&nbsp;Exploit</h2>
<p>I remember when I worked on the <span class="caps">IIS</span> de&shy;vel&shy;op&shy;ment team at Microsoft in 1997‚Äì2004,
we got hit by <a class="reference external" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2000-0884"><span class="caps">CVE</span>-2000-0884</a> in 2000,
which made use of an <a class="reference external" href="https://en.wikipedia.org/wiki/UTF-8#Overlong_encodings">overlong <span class="caps">UTF</span>-8 encoding</a>.</p>
<p>URLs allow <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Glossary/percent-encoding">percent encoding</a> for characters that can&#8217;t be sent literally.
For example, <tt class="docutils literal">%3D</tt> encodes an <tt class="docutils literal">=</tt>
as the two-digit hexa&shy;dec&shy;i&shy;mal value of <tt class="docutils literal">=</tt>‚Äôs <span class="caps">ASCII</span> code.
<span class="caps">UTF</span>-8 characters beyond U+007F require two or more bytes of storage,
each of which can be percent encoded;
e.g., U+00C1 (<tt class="docutils literal">√Å</tt>) is encoded as the <tt class="docutils literal">C3 81</tt> byte pair in <span class="caps">UTF</span>-8,
and as <tt class="docutils literal">%C3%81</tt> in percent&nbsp;encoding.</p>
<p>The slash character, <tt class="docutils literal">/</tt> or U+002F, can be percent encoded as <tt class="docutils literal">%2F</tt>.
<span class="caps">IIS</span> 4 and 5 were smart enough to treat <tt class="docutils literal">%2F</tt> as a slash
and to defend against sequences like <tt class="docutils literal"><span class="pre">..%2F..%2F</span></tt>.
However, the attackers encoded a slash as <tt class="docutils literal">%C0%<span class="caps">AF</span></tt>‚Äîa sequence that is burned into my brain.
This two-byte <span class="caps">UTF</span>-8 sequence can be decoded as U+002F,
though it should not be treated as valid
as it is <a class="reference external" href="https://en.wikipedia.org/wiki/UTF-8#Overlong_encodings">overlong</a>:
the five payload bits in the leading byte are all&nbsp;zero.</p>
<p>The <a class="reference external" href="https://www.giac.org/paper/gcih/115/iis-unicode-exploit/101163"><span class="caps">GIAC</span> paper</a> explains in some detail how this could be&nbsp;exploited.</p>
</div>
<div class="section" id="windows-security-push">
<h2>Windows Security&nbsp;Push</h2>
<p>Windows <span class="caps">XP</span> went on sale in late 2001,
touted as the most secure version of Windows ever.
(It was, at that&nbsp;time.)</p>
<p>Right around Christmas 2001,
the <a class="reference external" href="https://www.giac.org/paper/gcih/274/windows-xp-upnp-exploits/102906">UPnP vul&shy;ner&shy;a&shy;bilty</a> was disclosed.
Brian Valentine, the Senior <span class="caps">VP</span> who ran Windows, threw a shitfit.
It was announced that <em>all</em> of Windows would spend the month of February 2002
undergoing security training,
so that we could <a class="reference external" href="https://owasp.org/www-community/Threat_Modeling">threat model</a> and review our&nbsp;code.</p>
<p>For <span class="caps">IIS</span> 6, which would be released in Windows Server 2003,
we had fun&shy;da&shy;men&shy;tal&shy;ly rearchi&shy;tect&shy;ed it with a new worker process model
(inspired by Apache&#8217;s) and we had rewritten much of it.
There was a new kernel mode driver, http.sys,
that terminated all requests and routed them
to the ap&shy;pro&shy;pri&shy;ate handler in kernel or user mode.
I was part of the http.sys dev team at that&nbsp;point.</p>
<p><span class="caps">IIS</span> had already gotten serious about security by then.
We had to, after <a class="reference external" href="https://en.wikipedia.org/wiki/Code_Red_(computer_worm)">Code Red</a>, <a class="reference external" href="https://en.wikipedia.org/wiki/Nimda">Nimda</a>, the Unicode exploit, and others.
<a class="reference external" href="https://www.linkedin.com/in/mikehow/">Mike Howard</a> had been the <span class="caps">IIS</span> Security Program Manager
before he went on to bigger re&shy;spon&shy;si&shy;b&shy;li&shy;ties.
A lot of the first edition of his <a class="reference external" href="https://www.amazon.com/Writing-Secure-Second-Developer-Practices/dp/0735617228">Writing Secure Code</a> book
was based on his experience with securing <span class="caps">IIS</span>,
and a lot of the second edition benefited from the Security Push&nbsp;experience.</p>
<p>Since http.sys was new and an obvious target,
our team actually spent two months carefully reviewing everything.
It turned out that we had done a good job over the previous couple of years
and we didn&#8217;t find much to worry&nbsp;about.</p>
<p>We did identify that the <span class="caps">URL</span> canon&shy;i&shy;cal&shy;iza&shy;tion in http.sys
was overly com&shy;pli&shy;cat&shy;ed.
I rewrote that component and I created a ton of unit tests for it.
Developers writing unit tests was not common at Microsoft back in 2002:
we had a separate caste of testers to write&nbsp;tests.</p>
<p>I&#8217;ve been out of the loop since I left <span class="caps">IIS</span> in 2004,
but to my knowledge, there were no further vul&shy;ner&shy;a&shy;bil&shy;i&shy;ties in <span class="caps">URL</span>&nbsp;handling.</p>
<p>I&#8217;m surprised and dis&shy;ap&shy;point&shy;ed that Apache would mess up path traversal in the&nbsp;2020s.</p>
</div>

    <footer>
        
        
            <p>tagged as
                <a href="/tag/iis/" rel="tag">iis</a>,
                <a href="/tag/security/" rel="tag">security</a>
                    and
                    
                <a href="/tag/unicode/" rel="tag">unicode</a>
                
            </p>
        
    </footer>
    <div class="comments">
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = 'georgevreilly'; // required: replace example with your forum shortname

            // The following are highly recommended additional parameters. Remove the slashes in front to use.
            var disqus_identifier = "https://www.georgevreilly.com/blog/2021/10/05/PathTraversalAttacks.html";
            var disqus_url = "https://www.georgevreilly.com/blog/2021/10/05/PathTraversalAttacks.html";

            if (window.location.hostname != "localhost") {
                /* * * DON'T EDIT BELOW THIS LINE * * */
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            }
        </script>
        <noscript>
            <p>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></p>
        </noscript>
        <a href="https://disqus.com" class="dsq-brlink">
            blog comments powered by <span class="logo-disqus">Disqus</span>
        </a>
        </div>
</article>


    
    
        <a href="/blog/2021/10/04/AccidentallyQuadraticPythonListMembership.html" class="page floatright">
        Accidentally Quadratic: Python List Membership &raquo;
        </a>
    
    
        <a href="/blog/2021/12/28/ReviewCraftingInterpreters.html" class="page floatleft">
        &laquo; Review: Crafting Interpreters
        </a>
<footer>
    
    
    <p>written by <a href="mailto:george@reilly.org">George V. Reilly</a></p>
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="copyright license">
        <img src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" alt="by-nc-sa" />
    </a>
    
    

  </footer>
</body>
</html>
